<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>JSON → MIDI コンバーター</title>
  <script src="https://cdn.jsdelivr.net/npm/midi-writer-js@2.1.4/build/MidiWriter.min.js"></script>
  <style>
    body { font-family: sans-serif; background: #111; color: #eee; }
    textarea { width: 100%; height: 300px; background: #222; color: #0f0; }
    button { font-size: 16px; padding: 10px; margin-top: 10px; }
  </style>
</head>
<body>

<h1>JSON → MIDI</h1>

<p>複数トラック / 楽器反映 / ドラム対応</p>

<textarea id="jsonInput">
{
  "tempo": 150,
  "tracks": [
    {
      "name": "melody",
      "program": 81,
      "notes": [
        { "pitch": 76, "start": 0, "duration": 1 },
        { "pitch": 79, "start": 1, "duration": 1 }
      ]
    },
    {
      "name": "bass",
      "program": 33,
      "notes": [
        { "pitch": 45, "start": 0, "duration": 2 }
      ]
    },
    {
      "name": "drums",
      "isDrum": true,
      "notes": [
        { "pitch": 36, "start": 0, "duration": 0.25 },
        { "pitch": 38, "start": 0.5, "duration": 0.25 }
      ]
    }
  ]
}
</textarea>

<button onclick="generateMidi()">MIDIを生成</button>

<script>
function generateMidi() {
  try {
    const data = JSON.parse(document.getElementById("jsonInput").value);
    const tracks = [];
    const ticksPerBeat = 480;

    data.tracks.forEach((t, index) => {
      const track = new MidiWriter.Track();
      if (index === 0) track.setTempo(data.tempo || 120);

      const channel = t.isDrum ? 9 : index % 16;

      if (!t.isDrum) {
        track.addEvent(
          new MidiWriter.ProgramChangeEvent({
            instrument: t.program ?? 0,
            channel
          })
        );
      }

      t.notes.forEach(n => {
        track.addEvent(
          new MidiWriter.NoteEvent({
            pitch: [n.pitch],
            startTick: Math.round(n.start * ticksPerBeat),
            duration: "T" + Math.round(n.duration * ticksPerBeat),
            channel
          })
        );
      });

      tracks.push(track);
    });

    const writer = new MidiWriter.Writer(tracks);
    const blob = new Blob([writer.buildFile()], { type: "audio/midi" });

    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "output.mid";
    a.click();

  } catch (e) {
    alert("エラー:\n" + e.message);
    console.error(e);
  }
}

    const writer = new MidiWriter.Writer(tracks);
    const blob = new Blob([writer.buildFile()], { type: "audio/midi" });

    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "output.mid";
    a.click();

  } catch (e) {
    alert("エラー:\n" + e.message);
    console.error(e);
  }
}

    // ノート追加
    t.notes.forEach(n => {
      track.addEvent(
        new MidiWriter.NoteEvent({
          pitch: [n.pitch],
          startTick: Math.round(n.start * ticksPerBeat),
          duration: "T" + Math.round(n.duration * ticksPerBeat),
          channel: channel
        })
      );
    });

    tracks.push(track);
  });

  const writer = new MidiWriter.Writer(tracks);
  const blob = new Blob([writer.buildFile()], { type: "audio/midi" });

  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "output.mid";
  a.click();
}
</script>

</body>
</html>
